---
title: "Visualize Filtering"
author: ""
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: FALSE 
    code_folding: "hide"
    toc: true
    toc_float: false 
    toc_collapsed: true
toc_depth: 3
number_sections: true
theme: lumen
editor_options:
  chunk_output_type: inline
---
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r}
basedir <- getwd()
# basedir <- "."
# tmp <- "results/{project_name}/data/registration_metric/report/{project_name}_registration_evaluation.html"
# basedir <- Reduce(file.path, rep("..",length(strsplit(dirname(snakemake@output[["html"]]),"/")[[1]])))

input_csv_files <- snakemake@input[["registration_metrics_combined"]]
project_name <- basename(dirname(dirname(dirname(input_csv_files))))
sample_names <- read.csv(input_csv_files[1])$sample

IMS_to_postIMS_svg <- sapply(snakemake@input[["IMS_to_postIMS_svg"]], function(s) file.path(basedir,s))

IMS_to_postIMS_png <- sapply(snakemake@input[["IMS_to_postIMS_png"]], function(s) file.path(basedir,s))

preIMSmask_to_postIMSmask_png <- sapply(snakemake@input[["preIMSmask_to_postIMSmask_png"]], function(s) file.path(basedir,s))

preIMCmask_to_preIMSmask_png <- sapply(snakemake@input[["preIMCmask_to_preIMSmask_png"]], function(s) file.path(basedir,s))

postIMCmask_to_preIMCmask_png <- sapply(snakemake@input[["postIMCmask_to_preIMCmask_png"]], function(s) file.path(basedir,s))

landmarks_postIMC_transformed_on_preIMC_png <- sapply(snakemake@input[["landmarks_postIMC_transformed_on_preIMC_png"]], function(s) file.path(basedir,s))
landmarks_preIMC_png <- sapply(snakemake@input[["landmarks_preIMC_png"]], function(s) file.path(basedir,s))

landmarks_preIMC_transformed_on_preIMS_png <- sapply(snakemake@input[["landmarks_preIMC_transformed_on_preIMS_png"]], function(s) file.path(basedir,s))
landmarks_preIMS_png <- sapply(snakemake@input[["landmarks_preIMS_png"]], function(s) file.path(basedir,s))

landmarks_preIMS_transformed_on_postIMS_png <- sapply(snakemake@input[["landmarks_preIMS_transformed_on_postIMS_png"]], function(s) file.path(basedir,s))
landmarks_postIMS_png <- sapply(snakemake@input[["landmarks_postIMS_png"]], function(s) file.path(basedir,s))


regions_postIMC_transformed_on_preIMC_png <- sapply(snakemake@input[["regions_postIMC_transformed_on_preIMC_png"]], function(s) file.path(basedir,s))
regions_preIMC_transformed_on_preIMS_png <- sapply(snakemake@input[["regions_preIMC_transformed_on_preIMS_png"]], function(s) file.path(basedir,s))
regions_preIMS_transformed_on_postIMS_png <- sapply(snakemake@input[["regions_preIMS_transformed_on_postIMS_png"]], function(s) file.path(basedir,s))
regions_postIMC_transformed_on_postIMS_png <- sapply(snakemake@input[["regions_postIMC_transformed_on_postIMS_png"]], function(s) file.path(basedir,s))
```


```{r, eval=FALSE}
basedir <- "/home/retger/Nextcloud/Projects/test_imc_to_ims_workflow/imc_to_ims_workflow"
# project_name <- "test_combined"
# sample_names <- c("Cirrhosis-TMA-5_New_Detector_001", "Cirrhosis-TMA-5_New_Detector_002")
input_csv_files <- c("/home/retger/Nextcloud/Projects/test_imc_to_ims_workflow/imc_to_ims_workflow/results/test_combined/data/registration_metric/test_combined_reg_metrics_combined.csv")
vis_type <- "preIMS_to_postIMS"
```


```{r}
pairs_plot <- function(input_csv_files, vis_type, quantile_type="quantile50"){
  stopifnot(quantile_type %in% c("mean","quantile05","quantile25","quantile50","quantile75","quantile95","min","max"))
  df <- read.csv(input_csv_files)
  colname_reg <- paste0(vis_type, "_")
  b1 <- stringr::str_detect(colnames(df), paste0("(^",vis_type,")|(_",vis_type,")"))
  t1 <- stringr::str_replace(vis_type,"_to_","_")
  b2 <- stringr::str_detect(colnames(df), paste0("(^",t1,")|(_",t1,")"))
  b3 <- colnames(df) %in% c("sample", "project")
  df <- df[, b1 | b2 | b3]
  colnames(df) <- stringr::str_replace(colnames(df), paste0(vis_type,"_"), "")
  colnames(df) <- stringr::str_replace(colnames(df), paste0("_",vis_type), "")
  colnames(df) <- stringr::str_replace(colnames(df), paste0("_",stringr::str_replace(vis_type,"_to_","_")), "")

  d <- plotly::highlight_key(df, ~sample)
  base <- plotly::plot_ly(
      d, 
      text = ~sample,
      # hoverinfo = "text",
      type = "scatter",
      mode = "markers",
      # color = 1,
      # colors = "Set1",
      marker = list(size = 10),
      showlegend = FALSE
  )
  pltls <- list()
  if("euclidean_distance_centroids" %in% colnames(df) & "dice_score" %in% colnames(df)){
  masks_plt <- 
    plotly::add_markers(base, 
      x = ~euclidean_distance_centroids, 
      y = ~dice_score, 
      marker=list(color='rgb(0,0,0)'),
      hovertemplate = paste0('<b>%{text}</b><br>Error: %{x:.2f}<br>Dice: %{y:.2f}')) |>
      plotly::layout(
      xaxis = list(range=c(0,max(df$euclidean_distance_centroids)*1.1), title = "Distance between centroids"),
      yaxis = list(range=c(0,1.1),title = "Dice coefficient")
      ) |>
    plotly::add_annotations(
      text = "Tissue masks",
      x = 0.5,
      y = 1,
      yref = "paper",
      xref = "paper",
      xanchor = "middle",
      yanchor = "top",
      showarrow = FALSE,
      font = list(size = 15)
    )
  pltls <- c(pltls, list(masks_plt))
  }
  axis_type = paste0(quantile_type,"_error")
  if(axis_type %in% colnames(df) & "n_points_total" %in% colnames(df)){
  landmarks_plt <- 
    plotly::add_markers(base, 
      x = dplyr::quo(!!dplyr::sym(axis_type)), 
      y = ~n_points_total,
      marker=list(color='rgb(0,0,0)'),
      hovertemplate = paste0('<b>%{text}</b><br>Error: %{x:.2f}<br>N landmarks: %{y:.2f}')) |>
      plotly::layout(
      xaxis = list(range=c(0,max(df[[axis_type]])*1.1),title = "Distance between landmarks"),
      yaxis = list(range=c(0,max(df$n_points_total)*1.1),title = "Number of landmarks")
    ) |>
    plotly::add_annotations(
      text = "Landmarks",
      x = 0.5,
      y = 1,
      yref = "paper",
      xref = "paper",
      xanchor = "middle",
      yanchor = "top",
      showarrow = FALSE,
      font = list(size = 15)
    )
  pltls <- c(pltls, list(landmarks_plt))
  }

  xaxis_type = paste0("regions_",quantile_type,"_error")
  yaxis_type = paste0("regions_",quantile_type,"_dice")
  if(xaxis_type %in% colnames(df) & yaxis_type %in% colnames(df) & "regions_n_points_total" %in% colnames(df)){
  regions_plt <- 
    plotly::add_markers(base, 
      x = dplyr::quo(!!dplyr::sym(xaxis_type)), 
      y = dplyr::quo(!!dplyr::sym(yaxis_type)), 
      color = ~regions_n_points_total,
      text = ~regions_n_points_total,
      hovertemplate = paste0('<b>%{text}</b><br>Error: %{x:.2f}<br>Dice: %{y:.2f}<br>N regions: %{text}')) |>
      plotly::layout(
      xaxis = list(range=c(0,max(df[[xaxis_type]])*1.1),title = "Distance between regions"),
      yaxis = list(range=c(0,1.1),title = "Dice coefficient")
    ) |>
    plotly::add_annotations(
      text = "Regions",
      x = 0.5,
      y = 1,
      yref = "paper",
      xref = "paper",
      xanchor = "middle",
      yanchor = "top",
      showarrow = FALSE,
      font = list(size = 15)
    )
  pltls <- c(pltls, list(regions_plt))
  }
  if(length(pltls)>0){
    fig <- plotly::subplot(
      pltls,
      titleX=TRUE,
      titleY=TRUE
      ) |>
      plotly::highlight(on = "plotly_hover", off = "plotly_doubleclick")
    return(fig)
  }else{
    return(NULL)
  }
}

```


```{r}
sitk_error_plot <- function(input_csv_files, vis_type="preIMS_to_postIMS"){
    colname_reg <- paste0(vis_type, "_")
    
    dfls <- lapply(input_csv_files, function(x) {
        df <- read.csv(x)
        df$project <- stringr::str_replace(basename(x),"_reg_metrics_combined.csv","")
        df <- df[,grepl(colname_reg, colnames(df)) | colnames(df) %in% c("sample", "project")]

        colnames(df) <- stringr::str_replace(colnames(df), colname_reg, "")
        colnames(df) <- stringr::str_replace(colnames(df),"quantile","Q" )
        df
    })
    df <- Reduce(rbind, dfls)

    # df$global_shift <- sqrt(colSums(rbind(df$global_x_shift**2, df$global_y_shift**2)))
    df$global_shift <- df$mean_error
    df$sitk_global_shift <- sqrt(colSums(rbind(df$sitk_global_x_shift**2, df$sitk_global_y_shift**2)))


    global_range <- range(unlist(lapply(colnames(df)[grepl("_shift",colnames(df))], function(x) df[[x]])))
    global_range[1] <- global_range[1]-1 
    global_range[2] <- global_range[2]+1

    d <- plotly::highlight_key(df, ~sample)
    base <- plotly::plot_ly(
        d, 
        text = ~sample,
        # hoverinfo = "text",
        type = "scatter",
        mode = "markers",
        color = ~project,
        colors = "Set1",
        marker = list(size = 10),
        showlegend = FALSE
    )
    fig <- plotly::subplot(
      plotly::add_markers(base, x = ~global_x_shift, y = ~sitk_global_x_shift,
        hovertemplate = paste0('<b>%{text}</b><br>X error Landmarks: %{y:.2f}<br>X error sitk: %{x:.2f}')) |>
        plotly::layout(
        xaxis = list(range=global_range, title = "X translation"),
        yaxis = list(range=global_range, title = "X translation sitk")
      ),
      plotly::add_markers(base, x = ~global_y_shift, y = ~sitk_global_y_shift,
        hovertemplate = paste0('<b>%{text}</b><br>Y error Landmarks: %{y:.2f}<br>Y error sitk: %{x:.2f}')) |>
        plotly::layout(
        xaxis = list(range=global_range, title = "Y translation"),
        yaxis = list(range=global_range, title = "Y translation sitk")
      ),
      plotly::add_markers(base, x = ~global_shift, y = ~sitk_global_shift,
        hovertemplate = paste0('<b>%{text}</b><br>Error Landmarks: %{y:.2f}<br>Error sitk: %{x:.2f}')) |>
        plotly::layout(
        xaxis = list(title = "translation"),
        yaxis = list(title = "translation sitk")
      )
    ) |> 
      plotly::add_annotations(
        text = "X translation",
        x = 0.15,
        y = 1,
        yref = "paper",
        xref = "paper",
        yanchor = "bottom",
        showarrow = FALSE,
        font = list(size = 15)
      ) |> 
      plotly::add_annotations(
        text = "Y translation",
        x = 0.5,
        y = 1,
        yref = "paper",
        xref = "paper",
        yanchor = "bottom",
        showarrow = FALSE,
        font = list(size = 15)
      ) |> 
      plotly::add_annotations(
        text = "Error",
        x = 0.85,
        y = 1,
        yref = "paper",
        xref = "paper",
        yanchor = "bottom",
        showarrow = FALSE,
        font = list(size = 15)
      ) |>
        plotly::layout(
        xaxis = list(title = "Landmarks"),
        yaxis = list(title = "sitk"),
        margin = list(t=50, b=150, l=50, r=50)
      ) |>
      plotly::highlight(on = "plotly_hover", off = "plotly_doubleclick")
    fig
}
```

```{r plot_images, results='asis', fig.width=8, fig.height=8, eval=FALSE, echo=FALSE}
cat("\n\n")
for (i in seq_along(filenames)) {
    filename <- filenames[i]
    if(file.exists(filename)){
        cat(sprintf("\n\n#### %s\n\n",sample_names[i]))
        cat(sprintf("<img src=\"%s\" alt=\"drawing\" height=\"%s\"/>",filename,img_height))
    }
}
cat("\n\n")
```

```{r plot_2_images, results='asis', fig.width=8, fig.height=8, eval=FALSE, echo=FALSE}
cat("\n\n")
for (i in seq_along(filenames1)) {
    filename1 <- filenames1[i]
    filename2 <- filenames2[i]
    if(file.exists(filename1) & file.exists(filename2)){
        cat(sprintf("\n\n#### %s\n\n",sample_names[i]))
        cat("<p float=\"left\">")
        cat(sprintf("<img src=\"%s\" alt=\"drawing\" width=\"50%%\"/>",filename1))
        cat(sprintf("<img src=\"%s\" alt=\"drawing\" width=\"50%%\"/>",filename2))
        cat("</p>")
    }
}
cat("\n\n")
```


```{r pairs_plots, results='asis', fig.width=16, fig.height=8, echo=FALSE, eval=FALSE}
cat(sprintf("\n\n### %s\n\n","quantile50"))
pairs_plot(input_csv_files, vis_type,"quantile50")
cat(sprintf("\n\n### %s\n\n","mean"))
pairs_plot(input_csv_files, vis_type,"mean")
cat(sprintf("\n\n### %s\n\n","quantile05"))
pairs_plot(input_csv_files, vis_type,"quantile05")
cat(sprintf("\n\n### %s\n\n","quantile95"))
pairs_plot(input_csv_files, vis_type,"quantile95")
cat(sprintf("\n\n### %s\n\n","min"))
pairs_plot(input_csv_files, vis_type,"min")
cat(sprintf("\n\n### %s\n\n","max"))
pairs_plot(input_csv_files, vis_type,"max")
cat("\n\n")
```



# IMS to postIMS

## Ablation marks & registered IMS pixels {.tabset}

The images shown below are the ablation marks (from the postIMS microscopy image) and the IMS pixels (from the IMS image) after registration. 
Color legend for the below images:

| Color | Description  |
|-------|--------------|
| Blue  | Ablation marks |
| Green | IMS pixel    |

```{r}
filenames <- IMS_to_postIMS_svg
img_height=1000
```
```{r plot_images_IMS_to_postIMS, ref.label='plot_images', results='asis'}
```

## Distances ablation marks to IMS pixels {.tabset}

The plot below shows the distances (mean, median, etc.) on the x-axis versus the completeness (number of detected ablation marks divided by the total number of IMS pixels) on the y-axis.

```{r}
vis_type <- "IMS_to_postIMS"
```
```{r pairs_plots_IMS_to_postIMS, ref.label='pairs_plots', results='asis', fig.width=7, fig.height=7}
```


# postIMC to postIMS

## Summary plots of the registration metrics {.tabset}

| Position | Measure | x-axis | y-axis | color  | 
|:---------|:--------|:-------|:-------|:-------|
| Middle    | Regions | Summarized distance between regions | Dice coefficients | Number of regions |


```{r}
vis_type <- "postIMC_to_postIMS"
imgtype1 <- stringr::str_split(vis_type,"_to_")[[1]][1]
imgtype2 <- stringr::str_split(vis_type,"_to_")[[1]][2]
```
```{r pairs_plots_postIMC_to_postIMS, ref.label='pairs_plots', results='asis', fig.width=12, fig.height=7}
```


## Images {.tabset}

### Images of Regions {.tabset}

Below are shown the regions from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. 

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |


```{r}
filenames <- regions_postIMC_transformed_on_postIMS_png
img_height=700
```
```{r plot_images_postIMC_to_postIMS_regions, ref.label='plot_images', results='asis'}
```



# preIMS to postIMS

## Summary plots of the registration metrics {.tabset}

| Position | Measure | x-axis | y-axis | color  | 
|:---------|:--------|:-------|:-------|:-------|
| Left     | Tissue masks | Distance between centroids | Dice coefficient | |
| Middle   | Landmarks | Summarized distance between landmarks | Number of landmarks | |
| Right    | Regions | Summarized distance between regions | Dice coefficients | Number of regions |


```{r}
vis_type <- "preIMS_to_postIMS"
imgtype1 <- stringr::str_split(vis_type,"_to_")[[1]][1]
imgtype2 <- stringr::str_split(vis_type,"_to_")[[1]][2]
```
```{r pairs_plots_preIMS_to_postIMS, ref.label='pairs_plots', results='asis', fig.width=12, fig.height=7}
```

## Images {.tabset}

### Tissue masks {.tabset}

Shown below are the masks of the tissue masks, overlayed on top of each other. Extraction of the tissue masks is not always exact (especially for the postIMS images), so the results might be unreliable.
Color legend for the below images:

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |

```{r}
filenames <- preIMSmask_to_postIMSmask_png
img_height=700
```
```{r plot_images_preIMS_to_postIMS_mask, ref.label='plot_images', results='asis'}
```

### Images of Landmarks {.tabset}

Below are shown the landmarks from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. The landmarks are shown as errors where the start of the arrow is on the respective image and the end is the corresponding landmark in the other image. The length of the arrows are therefore the distance between individual landmarks. 

|left | right|
|:----|:-----|
|`r imgtype1` | `r imgtype2` |


```{r}
filenames1 <- landmarks_preIMS_transformed_on_postIMS_png
filenames2 <- landmarks_postIMS_png
```
```{r plot_2_images_preIMS_to_postIMS_landmarks, ref.label='plot_2_images', results='asis', fig.width=8, fig.height=8}
```

### Images of Regions {.tabset}

Below are shown the regions from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. 

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |


```{r}
filenames <- regions_preIMS_transformed_on_postIMS_png
img_height=700
```
```{r plot_images_preIMS_to_postIMS_regions, ref.label='plot_images', results='asis'}
```



## Translations based on grid subtracted postIMS to preIMS registration

The plot below shows the translations (x and y) based on the grid subtracted postIMS to preIMS registration (using image intensities). The leftmost plot shows the translation in the X direction with the x-axis representing the infered translation from the landmarks and the y-axis the infered translation from the grid subtracted registration. The middle plot shows the same but in the Y direction. The rightmost plot shows the global translation (sqrt(x^2+y^2)) with the x-axis representing the infered translation from the landmarks and the y-axis the infered translation from the grid subtracted registration.


```{r, fig.width=10, fig.height=5}
fig <- sitk_error_plot(input_csv_files, "preIMS_to_postIMS")
fig
```


# preIMC to preIMS

## Summary plots of the registration metrics {.tabset}

| Position | Measure | x-axis | y-axis | color  | 
|:---------|:--------|:-------|:-------|:-------|
| Left     | Tissue masks | Distance between centroids | Dice coefficient | |
| Middle   | Landmarks | Summarized distance between landmarks | Number of landmarks | |
| Right    | Regions | Summarized distance between regions | Dice coefficients | Number of regions |


```{r}
vis_type <- "preIMC_to_preIMS"
imgtype1 <- stringr::str_split(vis_type,"_to_")[[1]][1]
imgtype2 <- stringr::str_split(vis_type,"_to_")[[1]][2]
```
```{r pairs_plots_preIMC_to_preIMS, ref.label='pairs_plots', results='asis', fig.width=12, fig.height=7}
```


## Images {.tabset}

### Tissue masks {.tabset}

Shown below are the masks of the tissue masks, overlayed on top of each other. Extraction of the tissue masks is not always exact (especially for the postIMS images), so the results might be unreliable.
Color legend for the below images:

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |

```{r}
filenames <- preIMCmask_to_preIMSmask_png
img_height=700
```
```{r plot_images_preIMC_to_preIMS_mask, ref.label='plot_images', results='asis'}
```

### Images of Landmarks {.tabset}

Below are shown the landmarks from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. The landmarks are shown as errors where the start of the arrow is on the respective image and the end is the corresponding landmark in the other image. The length of the arrows are therefore the distance between individual landmarks. 

|left | right|
|:----|:-----|
|`r imgtype1` | `r imgtype2` |


```{r}
filenames1 <- landmarks_preIMC_transformed_on_preIMS_png
filenames2 <- landmarks_preIMS_png
```
```{r plot_2_images_preIMC_to_preIMS_landmarks, ref.label='plot_2_images', results='asis', fig.width=8, fig.height=8}
```

### Images of Regions {.tabset}

Below are shown the regions from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. 

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |


```{r}
filenames <- regions_preIMC_transformed_on_preIMS_png
img_height=700
```
```{r plot_images_preIMC_to_preIMS_regions, ref.label='plot_images', results='asis'}
```


# postIMC to preIMC

## Summary plots of the registration metrics {.tabset}

| Position | Measure | x-axis | y-axis | color  | 
|:---------|:--------|:-------|:-------|:-------|
| Left     | Tissue masks | Distance between centroids | Dice coefficient | |
| Middle   | Landmarks | Summarized distance between landmarks | Number of landmarks | |
| Right    | Regions | Summarized distance between regions | Dice coefficients | Number of regions |


```{r}
vis_type <- "postIMC_to_preIMC"
imgtype1 <- stringr::str_split(vis_type,"_to_")[[1]][1]
imgtype2 <- stringr::str_split(vis_type,"_to_")[[1]][2]
```
```{r pairs_plots_postIMC_to_preIMC, ref.label='pairs_plots', results='asis', fig.width=12, fig.height=7}
```


## Images {.tabset}

### Tissue masks {.tabset}

Shown below are the masks of the tissue masks, overlayed on top of each other. Extraction of the tissue masks is not always exact (especially for the postIMS images), so the results might be unreliable.
Color legend for the below images:

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |

```{r}
filenames <- postIMCmask_to_preIMCmask_png
img_height=700
```
```{r plot_images_postIMC_to_preIMC_mask, ref.label='plot_images', results='asis'}
```

### Images of Landmarks {.tabset}

Below are shown the landmarks from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. The landmarks are shown as errors where the start of the arrow is on the respective image and the end is the corresponding landmark in the other image. The length of the arrows are therefore the distance between individual landmarks. 

|left | right|
|:----|:-----|
|`r imgtype1` | `r imgtype2` |


```{r}
filenames1 <- landmarks_postIMC_transformed_on_preIMC_png
filenames2 <- landmarks_preIMC_png
```
```{r plot_2_images_postIMC_to_preIMC_landmarks, ref.label='plot_2_images', results='asis', fig.width=8, fig.height=8}
```

### Images of Regions {.tabset}

Below are shown the regions from the `r imgtype1` image (left) and the `r imgtype2` image (right) after registration. 

| Color | Description |
|-------|-------------|
| Black | Neither     |
| Dark gray  | `r imgtype1` only |
| Light gray  | `r imgtype2` only |
| White | Both        |


```{r}
filenames <- regions_postIMC_transformed_on_preIMC_png
img_height=700
```
```{r plot_images_postIMC_to_preIMC_regions, ref.label='plot_images', results='asis'}
```

